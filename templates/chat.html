<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script>
        var socket = io();  // Initialize Socket.IO client

        // On page load: join the room and then load history
        window.onload = function() {
            const sender   = "{{ session['username'] }}";
            const receiver = document.getElementById("receiver").value;

            // Tell the server we want to join this private room
            socket.emit('join_room', { username: sender, receiver: receiver });

            // Now fetch and render chat history
            loadChat();
        };

        // Function to send the message
        function sendMessage() {
            var receiver = document.getElementById("receiver").value;
            var message = document.getElementById("message").value;

            console.log("Sending message:", message);  // Debugging log

            if (message.trim() === "") {
                alert("Please enter a message.");
                return;  // Don't send empty messages
            }

            // Emit the message via Socket.IO to the server
            socket.emit('send_message', {
                sender: '{{ session["username"] }}',
                receiver: receiver,
                message: message
            });

            // Clear the message input field
            document.getElementById("message").value = ""; 
        }

        // Listen for new messages in real-time
        socket.on('receive_message', function(data) {
            var chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += `<p><strong>${data.sender}:</strong> ${data.message}</p>`;
            chatBox.scrollTop = chatBox.scrollHeight;  // Scroll to the bottom
        });

        // Load previous chat messages
        function loadChat() {
            var receiver = document.getElementById("receiver").value;

            fetch(`/get_chat/${receiver}`)
                .then(response => response.json())
                .then(messages => {
                    var chatBox = document.getElementById("chat-box");
                    chatBox.innerHTML = "";
                    messages.forEach(msg => {
                        chatBox.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.message} <small>${msg.timestamp}</small></p>`;
                    });

                    // Auto-scroll to the latest message
                    chatBox.scrollTop = chatBox.scrollHeight;
                })
                .catch(error => {
                    console.error("Error loading chat:", error);
                });
        }
    </script>
</head>
<body>
    <h2>Chat with <span id="recipient-name">{{ username }}</span></h2>
    <input type="hidden" id="receiver" value="{{ username }}">
    <button onclick="loadChat()">Load Chat</button>

    <div id="chat-box" style="border:1px solid #ccc; height: 300px; overflow-y: scroll;"></div>

    <input type="text" id="message" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
</body>
</html>
